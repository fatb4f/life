#!/usr/bin/env bash
set -euo pipefail
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
source "$SCRIPT_DIR/common.sh"

SEEDS="$ROOT_DIR/seeds/milestones.csv"
API="$(repo_api)/milestones"

echo "==> Syncing milestones from $SEEDS"
tail -n +2 "$SEEDS" | while IFS=',' read -r TITLE DUE_ON DESC;
  # normalize date-only to RFC3339
  if [[ -n "$DUE_ON" read -r TITLE DUE_ON DESC;read -r TITLE DUE_ON DESC; "$DUE_ON" == [0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9] ]]; then
    DUE_ON="${DUE_ON}T00:00:00Z"
  fi
  # normalize date-only to RFC3339
  if [[ -n "$DUE_ON" read -r TITLE DUE_ON DESC;
  # normalize date-only to RFC3339
  if [[ -n "$DUE_ON" read -r TITLE DUE_ON DESC;read -r TITLE DUE_ON DESC; "$DUE_ON" == [0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9] ]]; then
    DUE_ON="${DUE_ON}T00:00:00Z"
  firead -r TITLE DUE_ON DESC;
  # normalize date-only to RFC3339
  if [[ -n "$DUE_ON" read -r TITLE DUE_ON DESC;read -r TITLE DUE_ON DESC; "$DUE_ON" == [0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9] ]]; then
    DUE_ON="${DUE_ON}T00:00:00Z"
  fi "$DUE_ON" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
    DUE_ON="${DUE_ON}T00:00:00Z"
  fi do
  TITLE_TRIM="$(echo "$TITLE" | xargs)"
  [[ -z "$TITLE_TRIM" ]] && continue
  # Check if exists
  MID=$(gh api "$API" --paginate --jq \
    '.[] | select(.title=="'"$TITLE_TRIM"'") | .number' || true)
  if [[ -n "$MID" ]]; then
    echo "Exists: $TITLE_TRIM (#$MID)"
    # GitHub REST has no edit for due_on/description via gh api shortcut reliably; skip
  else
    gh api -X POST "$API" \
      -f title="$TITLE_TRIM" \
      ${DUE_ON:+ -f due_on="$DUE_ON"} \
      -f state="open" \
      ${DESC:+ -f description="$DESC"} >/dev/null
    echo "Created: $TITLE_TRIM"
  fi
done
echo "Milestones synced âœ…"
