name: CI

on:
  push:
  pull_request:

jobs:
  cpp:
    name: C++ (GCC/Clang) on ${{ matrix.os }} with ${{ matrix.compiler }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        compiler: [gcc, clang]
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        working-directory: cpp
    steps:
      - uses: actions/checkout@v4
      - name: Select compiler (Unix)
        if: runner.os != 'Windows'
        run: |
          if [ "${{ matrix.compiler }}" = "gcc" ]; then
            echo "CXX=g++" >> $GITHUB_ENV
          else
            echo "CXX=clang++" >> $GITHUB_ENV
          fi
      - name: Set up MSVC (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Configure
        run: cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
        env:
          CXX: ${{ env.CXX }}
      - name: Build
        run: cmake --build build -j
      - name: Test
        run: ctest --test-dir build --output-on-failure

  rust:
    name: Rust on ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        working-directory: rust
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@stable
      - name: Build
        run: cargo build --workspace --all-targets
      - name: Test
        run: cargo test --workspace
      - name: Clippy
        run: cargo clippy --workspace --all-targets -- -D warnings
      - name: rustfmt check
        run: cargo fmt --all -- --check
