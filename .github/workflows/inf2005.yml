name: INF2005 Automation (Docs-only)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'INF2005/**'
      - '.github/workflows/inf2005.yml'

permissions:
  contents: write
  issues: write
  pull-requests: write

concurrency:
  group: inf2005-${{ github.ref }}
  cancel-in-progress: true

jobs:
  bootstrap:
    name: Ensure labels & milestones
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: GH sanity
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh --version
          gh auth status

      - name: Ensure labels and milestones
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          create_or_update_label() {
            local name="$1" color="$2" desc="$3"
            if gh label list -R "$REPO" --json name | jq -r '.[].name' | grep -qx "$name"; then
              gh label edit "$name" -R "$REPO" --color "$color" --description "$desc"
            else
              gh label create "$name" -R "$REPO" --color "$color" --description "$desc"
            fi
          }

          echo ">>> Labels"
          create_or_update_label "type:module" "1D76DB" "Module tracking"
          create_or_update_label "type:exercise" "A2EEEF" "Practice exercises"
          create_or_update_label "type:correction" "5319E7" "Corrections / review"
          create_or_update_label "prio:high" "B60205" "High priority items"
          create_or_update_label "INF:Review" "D4C5F9" "Review checkpoint (INF2005)"

          echo ">>> Milestones"
          gh api repos/$REPO/milestones --method GET --paginate > milestones.json || echo "[]" > milestones.json
          ensure_milestone() {
            local TITLE="$1"; local DUE="$2"
            if jq -e --arg t "$TITLE" '.[] | select(.title==$t)' milestones.json > /dev/null; then
              id=$(jq -r --arg t "$TITLE" '.[] | select(.title==$t) | .number' milestones.json)
              gh api repos/$REPO/milestones/$id --method PATCH -F title="$TITLE" -F due_on="${DUE}T00:00:00Z" || true
            else
              gh api repos/$REPO/milestones --method POST -F title="$TITLE" -F due_on="${DUE}T00:00:00Z" || true
            fi
          }
          ensure_milestone "INF: TP1 - Graded Evaluation" "2025-12-15"
          ensure_milestone "INF: Modules 1-2 Practice" "2025-11-30"
          ensure_milestone "INF: Modules 3-4 Practice" "2025-12-31"