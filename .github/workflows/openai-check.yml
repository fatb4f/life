name: openai-check
on:
workflow_dispatch:
pull_request:
types: [opened, synchronize, reopened]


permissions:
contents: read
pull-requests: write # needed only if PR comment step runs


jobs:
call-openai:
runs-on: ubuntu-latest


steps:
- uses: actions/checkout@v4


- name: Preflight: check secret presence
run: |
if [ -z "${{ secrets.OPENAI_API_KEY }}" ]; then
echo "Secret OPENAI_API_KEY is missing or not accessible to this job." >&2
echo "Check: repo vs environment secret, event type (no secrets for fork PRs), exact name." >&2
exit 1
else
echo "Secret looks present (non-empty)."
fi


- name: Test OpenAI Chat API via curl
env:
OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
run: |
set -euo pipefail
HTTP_CODE=$(curl -sS --max-time 30 https://api.openai.com/v1/chat/completions \
-H "Authorization: Bearer ${OPENAI_API_KEY}" \
-H "Content-Type: application/json" \
-d '{
"model": "gpt-4o-mini",
"messages": [
{"role": "system", "content": "You are a concise CI helper."},
{"role": "user", "content": "Say hello from GitHub Actions."}
]
}' \
-o resp.json -w "%{http_code}")
echo "HTTP ${HTTP_CODE}"
# Print either model content or error message to output.txt
jq -r '.choices[0].message.content // .error.message // "<no content>"' resp.json | tee output.txt
test "${HTTP_CODE}" -ge 200 -a "${HTTP_CODE}" -lt 300


- name: Upload response artifact
uses: actions/upload-artifact@v4
with:
name: openai-response
path: output.txt


- name: Comment result on PR
if: ${{ github.event_name == 'pull_request' }}
env:
GH_TOKEN: ${{ github.token }}
run: |
gh pr comment ${{ github.event.pull_request.number }} \
--body "ðŸ¤– OpenAI says:\n\n$(cat output.txt)"
